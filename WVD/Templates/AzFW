# Description
## Template will create a new firewall manager policy and add rules for AVD required URLS.

# Connect to Azure
Connect-AzAccount

# Set Parameters 
$Subscription = "9e087dff-9c5b-4650-96ee-19cfe5269c5d"
$ResourceGroupName = "Network-Rg"
$Location = "eastus"
$avdvnet = "WVD-Hub"
$AVDSubnet = "WVD"
$AzFwPrivateIP = "10.2.3.4"
$fwsku = "Standard"

# Choose your Subscription
Select-AzSubscription $Subscription

# Create Route
$routeTableFW = New-AzRouteTable `
 -Name "FwRouteTable" `
 -ResourceGroupName $ResourceGroupName `
 -Location $Location `
 -DisableBGPRoutePropagation

Add-AzRouteConfig `
 -Name "AVD-Route" `
 -RouteTable $routeTableFW `
 -AddressPrefix 0.0.0.0/0 `
 -NextHopType "VirtualAppliance" `
 -NextHopIpAddress $AzFwPrivateIP
#Set-AzRouteTable

# Associate to Subnet
$virtualNetwork = Get-AzVirtualNetwork `
 -Name $avdvnet `
 -ResourceGroupName $ResourceGroupName
 
$avdsubnetprefix = ($virtualnetwork.Subnets | where-object -property name -match $avdsubnet).AddressPrefix

Set-AzVirtualNetworkSubnetConfig `
  -Name $AVDSubnet `
  -AddressPrefix $avdsubnetprefix `
  -VirtualNetwork $virtualNetwork `
  -RouteTable $routeTableFW `
| Set-AzVirtualNetwork

# Create Firewall Policy
$firewallpolicy = New-AzFirewallPolicy `
 -Name AVDFWPolicy `
 -ResourceGroupName $ResourceGroupName `
 -Location $Location `
 -SkuTier $fwsku
  
# Create Application Rule Collection Group
$apprule1 = New-AzFirewallApplicationRule `
 -Name "fqdntags" `
 -FqdnTag WindowsVirtualDesktop,WindowsUpdate,WindowsDiagnostics,MicrosoftActiveProtectionService `
 -SourceAddress 10.2.0.0/24
 #-Protocol "https" 

$apprule2 = New-AzFirewallApplicationRule `
  -Name "kmsfqdn" `
  -SourceAddress 10.2.0.0/24 `
  -Protocol "https:1688" `
  -TargetFqdn "kms.core.windows.net"

$AppRuleCollection = New-AzFirewallApplicationRuleCollection `
  -Name "AVDAppRuleCollection" `
  -Priority 102 `
  -Rule $apprule1, $apprule2 `
  -ActionType "Allow"

 $firewallpolicy.ApplicationRuleCollections.Add($AppRuleCollection)

 Set-AzFirewallPolicy -InputObject $firewallpolicy


# Create Network Rule Collection Group
$netrule1 = New-AzFirewallNetworkRule `
 -Name "Port 80 Traffice" `
 -Description "Traffic for metadata and session host health monitoring"  `
 -Protocol TCP -SourceAddress 10.2.0.0/24 `
 -DestinationAddress 168.254.169.254,168.63.129.16 `
 -DestinationPort "80"

 $netrule2 = New-AzFirewallNetworkRule `
  -Name "AVD" `
  -Description "Sending AVD and Azure traffice" `
  -Protocol TCP -SourceAddress 10.2.0.0/24 `
  -DestinationAddress AzureCloud,WindowsVirtualDesktop `
  -DestinationPort "443"

$netrule3 = New-AzFirewallNetworkRule `
  -Name "DNS" `
  -Description "Route DNS Traffic" `
  -Protocol TCP,UDP `
  -SourceAddress 10.2.0.0/24 `
  -DestinationAddress "*" `
  -DestinationPort "53"

 $NetRuleCollection = New-AzFirewallNetworkRuleCollection `
   -Name "RC1" `
   -Priority 100 `
   -Rule $netrule1, $netrule2, $netrule3 `
   -ActionType "Allow"
  
 $firewallpolicy.NetworkRuleCollections.Add($NetRuleCollection)

 Set-AzFirewallPolicy -InputObject $firewallpolicy