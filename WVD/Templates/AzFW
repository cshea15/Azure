# Description
## Template will create a new firewall manager policy and add rules for AVD required URLS.

# Connect to Azure
Connect-AzAccount

# Set Parameters 
$Subscription = "9e087dff-9c5b-4650-96ee-19cfe5269c5d"
$ResourceGroupName = "Network-Rg"
$Location = "eastus"
$avdvnet = "WVD-Hub"
$AVDSubnet = "WVD"
$AzFwPrivateIP = "10.2.3.4"
$fwsku = "Standard"

# Choose your Subscription
Select-AzSubscription $Subscription

# Create Route
$routeTableFW = New-AzRouteTable `
 -Name "AvdFwRT" `
 -ResourceGroupName $ResourceGroupName `
 -Location $Location `
 -DisableBGPRoutePropagation

Add-AzRouteConfig `
 -Name "AVD-Route" `
 -RouteTable $routeTableFW `
 -AddressPrefix 0.0.0.0/0 `
 -NextHopType "VirtualAppliance" `
 -NextHopIpAddress $AzFwPrivateIP
#Set-AzRouteTable

# Associate to Subnet
$virtualNetwork = Get-AzVirtualNetwork `
 -Name $avdvnet `
 -ResourceGroupName $ResourceGroupName
 
$avdsubnetprefix = ($virtualnetwork.Subnets | where-object -property name -match $avdsubnet).AddressPrefix

Set-AzVirtualNetworkSubnetConfig `
  -Name $AVDSubnet `
  -AddressPrefix $avdsubnetprefix `
  -VirtualNetwork $virtualNetwork `
  -RouteTable $routeTableFW `
#| Set-AzVirtualNetwork

# Create Firewall Policy
$firewallpolicy = New-AzFirewallPolicy `
 -Name AVDFWPolicy `
 -ResourceGroupName $ResourceGroupName `
 -Location $Location `
 -SkuTier $fwsku
  
# Create Application Rule Collection Group
$apprule1 = New-AzFirewallPolicyApplicationRule `
 -Name "fqdntags" `
 -FqdnTag WindowsVirtualDesktop,WindowsUpdate,WindowsDiagnostics,MicrosoftActiveProtectionService `
 -Protocol "https:443" `
 -SourceAddress 10.2.0.0/24

 #-Protocol "https" 

$apprule2 = New-AzFirewallPolicyApplicationRule `
  -Name "kmsfqdn" `
  -SourceAddress 10.2.0.0/24 `
  -Protocol "https:1688" `
  -TargetFqdn "kms.core.windows.net"

$AppRuleCollection = New-AzFirewallPolicyFilterRuleCollection `
  -Name "AVDAppRuleCollection" `
  -Priority 102 `
  -Rule $apprule1, $apprule2 `
  -ActionType "Allow"

New-AzFirewallPolicyRuleCollectionGroup `
  -Name "AppRuleCollectionGroup" `
  -ResourceGroupName $ResourceGroupName `
  -Priority 105 `
  -RuleCollection $AppRuleCollection `
  -FirewallPolicyName $firewallpolicy.Name 
   
#$firewallpolicy.RuleCollectionGroups.Add($AppRuleCollectionGroup)
#Set-AzFirewallPolicy -InputObject $firewallpolicy


# Create Network Rule Collection Group
$netrule1 = New-AzFirewallPolicyNetworkRule `
 -Name "MetaData/Service Health" `
 -Description "Traffic for metadata and session host health monitoring"  `
 -Protocol TCP -SourceAddress 10.2.0.0/24 `
 -DestinationAddress 168.254.169.254,168.63.129.16 `
 -DestinationPort "80"

 $netrule2 = New-AzFirewallPolicyNetworkRule `
  -Name "AVD" `
  -Description "Sending AVD and Azure traffic" `
  -Protocol TCP -SourceAddress 10.2.0.0/24 `
  -DestinationAddress AzureCloud,WindowsVirtualDesktop `
  -DestinationPort "443"

$netrule3 = New-AzFirewallPolicyNetworkRule `
  -Name "DNS" `
  -Description "Route DNS Traffic" `
  -Protocol TCP,UDP `
  -SourceAddress 10.2.0.0/24 `
  -DestinationAddress "*" `
  -DestinationPort "53"

 $NetRuleCollection = New-AzFirewallPolicyFilterRuleCollection `
   -Name "NetRuleCollection" `
   -Priority 100 `
   -Rule $netrule1, $netrule2, $netrule3 `
   -ActionType "Allow"

New-AzFirewallPolicyRuleCollectionGroup `
  -Name "NetRuleApplicationGroup" `
  -ResourceGroupName $ResourceGroupName `
  -Priority 100 `
  -RuleCollection $NetRuleCollection `
  -FirewallPolicyName $firewallpolicy.Name  
  
#$firewallpolicy.RuleCollectionGroups($netrulecollectiongroup)
#Set-AzFirewallPolicy -InputObject $firewallpolicy