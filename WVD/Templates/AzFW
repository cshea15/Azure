# Description
## Template will create a new firewall manager policy and add rules for AVD required URLS.

# Connect to Azure
Connect-AzAccount

# Set Parameters 
$Subscription = "9e087dff-9c5b-4650-96ee-19cfe5269c5d"
$ResourceGroupName = "Network-Rg"
$Location = "eastus"
$AVDSubnet = "WVD"
$firewallpolicy = "AVDFirewallPolicy"
$AzFwPrivateIP = "10.2.3.4"
$fwsku = "Standard"

# Choose your Subscription
Select-AzSubscription $Subscription

# Create Route
$routeTableFW = New-AzRouteTable `
 -Name FwRouteTable `
 -ResourceGroupName = $ResourceGroupName `
 -Location = $Location `
 -DisableBGPRoutePropagation

Add-AzRouteConfig `
 -Name "AVD-Route" `
 -RouteTable $routeTableFW `
 -AddressPrefix 0.0.0.0/0 `
 -NextHopType "VirtualAppliance" `
 -NextHopIpAddress $AzFwPrivateIP `
  Set-AzRouteTable

# Associate to Subnet
Set-AzVirtualNetworkSubnetConfig `
  -VirtualNetwork $testVnet `
  -Name $AVDSubnet `
  -AddressPrefix 0.0.0.0/24 `
  -RouteTable $routeTableFW | Set-AzVirtualNetwork

# Create Firewall Policy
New-AzFirewallPolicy `
 -Name $firewallpolicy `
 -ResourceGroupName $ResourceGroupName `
 -SkuTier $fwsku

# Create Application Rule Collection Group
$apprule1 = New-AzFirewallApplicationRule `
 -Name "httpsRule" `
 -Protocol "https:443" `
 -TargetFqdn "*" `
 -SourceAddress "10.0.0.0"

 $apprule2 = New-AzFirewallApplicationRuleCollection `
  -Name "" `
  -Protocol "" `
  -TargetFqdn "" `
  -SourceAddress ""

 New-AzFirewallApplicationRuleCollection `
  -Name "AVDAppRuleCollection" `
  -Priority 100 `
  -Rule $apprule1, $apprule2 `
  -ActionType "Allow"

# Create Network Rule Collection Group
$netrule1 = New-AzFirewallNetworkRule `
 -Name "all-udp-traffic" `
 -Description "Rule for all UDP traffic" `
 -Protocol UDP -SourceAddress "*" `
 -DestinationAddress "*" `
 -DestinationPort "*"

 $netrule2 = New-AzFirewallNetworkRule `
  -Name "partial-tcp-rule" `
  -Description "Rule for all TCP traffic from 10.0.0.0 to 60.1.5.0:4040" `
  -Protocol TCP `
  -SourceAddress "10.0.0.0" `
  -DestinationAddress "60.1.5.0" 
  -DestinationPort "4040"

  New-AzFirewallNetworkRuleCollection `
   -Name RC1 `
   -Priority 100 `
   -Rule $netrule1, $netrule2 `
   -ActionType "Allow"
  